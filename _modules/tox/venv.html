
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tox.venv &#8212; tox 0.1.dev1 文档</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/translations.js"></script>
    <link rel="shortcut icon" href="../../_static/toxfavi.ico"/>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>tox.venv 源代码</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pipes</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>

<span class="kn">import</span> <span class="nn">py</span>

<span class="kn">import</span> <span class="nn">tox</span>
<span class="kn">from</span> <span class="nn">tox</span> <span class="kn">import</span> <span class="n">reporter</span>
<span class="kn">from</span> <span class="nn">tox.action</span> <span class="kn">import</span> <span class="n">Action</span>
<span class="kn">from</span> <span class="nn">tox.config.parallel</span> <span class="kn">import</span> <span class="n">ENV_VAR_KEY_PRIVATE</span> <span class="k">as</span> <span class="n">PARALLEL_ENV_VAR_KEY_PRIVATE</span>
<span class="kn">from</span> <span class="nn">tox.constants</span> <span class="kn">import</span> <span class="n">INFO</span><span class="p">,</span> <span class="n">PARALLEL_RESULT_JSON_PREFIX</span><span class="p">,</span> <span class="n">PARALLEL_RESULT_JSON_SUFFIX</span>
<span class="kn">from</span> <span class="nn">tox.package.local</span> <span class="kn">import</span> <span class="n">resolve_package</span>
<span class="kn">from</span> <span class="nn">tox.util.lock</span> <span class="kn">import</span> <span class="n">get_unique_file</span>
<span class="kn">from</span> <span class="nn">tox.util.path</span> <span class="kn">import</span> <span class="n">ensure_empty_dir</span>

<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">DepConfig</span>

<span class="c1">#: maximum parsed shebang interpreter length (see: prepend_shebang_interpreter)</span>
<span class="n">MAXINTERP</span> <span class="o">=</span> <span class="mi">2048</span>


<span class="k">class</span> <span class="nc">CreationConfig</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base_resolved_python_sha256</span><span class="p">,</span>
        <span class="n">base_resolved_python_path</span><span class="p">,</span>
        <span class="n">tox_version</span><span class="p">,</span>
        <span class="n">sitepackages</span><span class="p">,</span>
        <span class="n">usedevelop</span><span class="p">,</span>
        <span class="n">deps</span><span class="p">,</span>
        <span class="n">alwayscopy</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_resolved_python_sha256</span> <span class="o">=</span> <span class="n">base_resolved_python_sha256</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_resolved_python_path</span> <span class="o">=</span> <span class="n">base_resolved_python_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tox_version</span> <span class="o">=</span> <span class="n">tox_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sitepackages</span> <span class="o">=</span> <span class="n">sitepackages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usedevelop</span> <span class="o">=</span> <span class="n">usedevelop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alwayscopy</span> <span class="o">=</span> <span class="n">alwayscopy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="o">=</span> <span class="n">deps</span>

    <span class="k">def</span> <span class="nf">writeconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_resolved_python_sha256</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_resolved_python_path</span><span class="p">),</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:d}</span><span class="s2"> </span><span class="si">{:d}</span><span class="s2"> </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tox_version</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sitepackages</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">usedevelop</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alwayscopy</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">dep</span><span class="p">))</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">ensure</span><span class="p">()</span>
        <span class="n">path</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">content</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">readconfig</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="n">cr</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">base_resolved_python_info</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">tox_version</span><span class="p">,</span> <span class="n">sitepackages</span><span class="p">,</span> <span class="n">usedevelop</span><span class="p">,</span> <span class="n">alwayscopy</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">sitepackages</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sitepackages</span><span class="p">))</span>
            <span class="n">usedevelop</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">usedevelop</span><span class="p">))</span>
            <span class="n">alwayscopy</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">alwayscopy</span><span class="p">))</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">base_resolved_python_sha256</span><span class="p">,</span> <span class="n">depstring</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">deps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">base_resolved_python_sha256</span><span class="p">,</span> <span class="n">depstring</span><span class="p">))</span>
            <span class="n">base_resolved_python_sha256</span><span class="p">,</span> <span class="n">base_resolved_python_path</span> <span class="o">=</span> <span class="n">base_resolved_python_info</span>
            <span class="k">return</span> <span class="n">CreationConfig</span><span class="p">(</span>
                <span class="n">base_resolved_python_sha256</span><span class="p">,</span>
                <span class="n">base_resolved_python_path</span><span class="p">,</span>
                <span class="n">tox_version</span><span class="p">,</span>
                <span class="n">sitepackages</span><span class="p">,</span>
                <span class="n">usedevelop</span><span class="p">,</span>
                <span class="n">deps</span><span class="p">,</span>
                <span class="n">alwayscopy</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">matches_with_reason</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">deps_matches_subset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;base_resolved_python_sha256&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base_resolved_python_path&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tox_version&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sitepackages&quot;</span><span class="p">,</span>
            <span class="s2">&quot;usedevelop&quot;</span><span class="p">,</span>
            <span class="s2">&quot;alwayscopy&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">left</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">right</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">right</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;attr </span><span class="si">{}</span><span class="s2"> </span><span class="si">{!r}</span><span class="s2">!=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="n">self_deps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>
        <span class="n">other_deps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self_deps</span> <span class="o">!=</span> <span class="n">other_deps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">deps_matches_subset</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">other_deps</span> <span class="o">-</span> <span class="n">self_deps</span>
                <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;missing in previous </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2">!=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">self_deps</span><span class="p">,</span> <span class="n">other_deps</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">deps_matches_subset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">outcome</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_with_reason</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">deps_matches_subset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outcome</span>


<div class="viewcode-block" id="VirtualEnv"><a class="viewcode-back" href="../../plugins.html#tox.venv.VirtualEnv">[文档]</a><span class="k">class</span> <span class="nc">VirtualEnv</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envconfig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">popen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">env_log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span> <span class="o">=</span> <span class="n">envconfig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popen</span> <span class="o">=</span> <span class="n">popen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_log</span> <span class="o">=</span> <span class="n">env_log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_json_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">new_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">config</span>
        <span class="n">command_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_log</span><span class="o">.</span><span class="n">get_commandlog</span><span class="p">(</span>
            <span class="s2">&quot;test&quot;</span> <span class="k">if</span> <span class="n">msg</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;run-test&quot;</span><span class="p">,</span> <span class="s2">&quot;run-test-pre&quot;</span><span class="p">,</span> <span class="s2">&quot;run-test-post&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;setup&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Action</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">msg</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envlogdir</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">resultjson</span><span class="p">,</span>
            <span class="n">command_log</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">popen</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envpython</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">suicide_timeout</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">interrupt_timeout</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">terminate_timeout</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_result_json_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_json_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">resultjson</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_result_json_path</span> <span class="o">=</span> <span class="n">get_unique_file</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">PARALLEL_RESULT_JSON_PREFIX</span><span class="p">,</span>
                    <span class="n">PARALLEL_RESULT_JSON_SUFFIX</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_json_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">hook</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Path to environment base dir.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envdir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.tox-config1&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;test environment name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envname</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;VirtualEnv at </span><span class="si">{!r}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

<div class="viewcode-block" id="VirtualEnv.getcommandpath"><a class="viewcode-back" href="../../plugins.html#tox.venv.VirtualEnv.getcommandpath">[文档]</a>    <span class="k">def</span> <span class="nf">getcommandpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">venv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return absolute path (str or localpath) for specified command name.</span>

<span class="sd">        - If it&#39;s a local path we will rewrite it as as a relative path.</span>
<span class="sd">        - If venv is True we will check if the command is coming from the venv</span>
<span class="sd">          or is allowed to come from external.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">cwd</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">venv</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_venv_lookup_and_check_external_allowlist</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normal_lookup</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">InvocationError</span><span class="p">(</span>
                <span class="s2">&quot;could not find executable </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pipes</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">name</span><span class="p">)),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># will not be rewritten for reporting</span></div>

    <span class="k">def</span> <span class="nf">_venv_lookup_and_check_external_allowlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_venv_lookup</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normal_lookup</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_external_allowed_and_warn</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_venv_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">sysfind</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envbindir</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_normal_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">sysfind</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_external_allowed_and_warn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_allowed_external</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;test command found but not installed in testenv</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  cmd: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  env: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Maybe you forgot to specify a dependency? &quot;</span>
                <span class="s2">&quot;See also the allowlist_externals envconfig setting.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;DEPRECATION WARNING: this will be an error in tox 4 and above!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envdir</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_allowed_external</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">tryadd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tox</span><span class="o">.</span><span class="n">INFO</span><span class="o">.</span><span class="n">IS_WIN</span><span class="p">:</span>
            <span class="n">tryadd</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PATHEXT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">allowlist_externals</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">whitelist_externals</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">(</span>
                <span class="s2">&quot;Either whitelist_externals or allowlist_externals might be specified, not both&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">allowed_externals</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">whitelist_externals</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">allowlist_externals</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">allowed_externals</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">add</span> <span class="ow">in</span> <span class="n">tryadd</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">add</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="VirtualEnv.update"><a class="viewcode-back" href="../../plugins.html#tox.venv.VirtualEnv.update">[文档]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return status string for updating actual venv to match configuration.</span>
<span class="sd">        if status string is empty, all is ok.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rconfig</span> <span class="o">=</span> <span class="n">CreationConfig</span><span class="o">.</span><span class="n">readconfig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_config</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">recreate</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;-r flag&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rconfig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;no previous config </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_config</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">live_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getliveconfig</span><span class="p">()</span>
                <span class="n">deps_subset_match</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="p">,</span> <span class="s2">&quot;deps_matches_subset&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">outcome</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">rconfig</span><span class="o">.</span><span class="n">matches_with_reason</span><span class="p">(</span><span class="n">live_config</span><span class="p">,</span> <span class="n">deps_subset_match</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">action</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reusing&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envdir</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">action</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;cannot reuse&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rconfig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">action</span><span class="o">.</span><span class="n">setactivity</span><span class="p">(</span><span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envdir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action</span><span class="o">.</span><span class="n">setactivity</span><span class="p">(</span><span class="s2">&quot;recreate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envdir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">tox_testenv_create</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">venv</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">just_created</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedInterpreter</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exception</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">tox_testenv_install_deps</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">venv</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">InvocationError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;could not install deps </span><span class="si">{}</span><span class="s2">; v = </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">deps</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_getliveconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base_resolved_python_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">python_info</span><span class="o">.</span><span class="n">executable</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">tox</span><span class="o">.</span><span class="n">__version__</span>
        <span class="n">sitepackages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">sitepackages</span>
        <span class="n">develop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">usedevelop</span>
        <span class="n">alwayscopy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">alwayscopy</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolved_dependencies</span><span class="p">():</span>
            <span class="n">dep_name_sha256</span> <span class="o">=</span> <span class="n">getdigest</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">deps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dep_name_sha256</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">base_resolved_python_sha256</span> <span class="o">=</span> <span class="n">getdigest</span><span class="p">(</span><span class="n">base_resolved_python_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CreationConfig</span><span class="p">(</span>
            <span class="n">base_resolved_python_sha256</span><span class="p">,</span>
            <span class="n">base_resolved_python_path</span><span class="p">,</span>
            <span class="n">version</span><span class="p">,</span>
            <span class="n">sitepackages</span><span class="p">,</span>
            <span class="n">develop</span><span class="p">,</span>
            <span class="n">deps</span><span class="p">,</span>
            <span class="n">alwayscopy</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_resolved_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dependency</span><span class="o">.</span><span class="n">indexserver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">package</span> <span class="o">=</span> <span class="n">resolve_package</span><span class="p">(</span><span class="n">package_spec</span><span class="o">=</span><span class="n">dependency</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">package</span> <span class="o">!=</span> <span class="n">dependency</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">dependency</span> <span class="o">=</span> <span class="n">dependency</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
            <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dependencies</span>

    <span class="k">def</span> <span class="nf">getsupportedinterpreter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">getsupportedinterpreter</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">matching_platform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">previous_config</span> <span class="o">=</span> <span class="n">CreationConfig</span><span class="o">.</span><span class="n">readconfig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_config</span><span class="p">)</span>
        <span class="n">live_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getliveconfig</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">previous_config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">previous_config</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">live_config</span><span class="p">):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">live_config</span><span class="o">.</span><span class="n">writeconfig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_config</span><span class="p">)</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">verbosity1</span><span class="p">(</span><span class="s2">&quot;write config to </span><span class="si">{}</span><span class="s2"> as </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_config</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_needs_reinstall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setupdir</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="n">setup_py</span> <span class="o">=</span> <span class="n">setupdir</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;setup.py&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">setup_py</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">setup_cfg</span> <span class="o">=</span> <span class="n">setupdir</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;setup.cfg&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envpython</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">setup_py</span><span class="p">),</span> <span class="s2">&quot;--name&quot;</span><span class="p">]</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_os_environ</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="n">setupdir</span><span class="p">,</span>
            <span class="n">redirect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">returnout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">capture_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;pydev debugger:&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envpython</span><span class="p">,</span>
            <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
            <span class="s2">&quot;import sys;  import json; print(json.dumps(sys.path))&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">redirect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sys_path</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">sys_path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">egg_info_fname</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span> <span class="s2">&quot;egg-info&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">sys_path</span><span class="p">):</span>
            <span class="n">egg_info</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">egg_info_fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">egg_info</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">needs_reinstall</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">conf_file</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="ow">and</span> <span class="n">conf_file</span><span class="o">.</span><span class="n">mtime</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">egg_info</span><span class="o">.</span><span class="n">mtime</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">conf_file</span> <span class="ow">in</span> <span class="p">(</span><span class="n">setup_py</span><span class="p">,</span> <span class="n">setup_cfg</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Ensure the modification time of the egg-info folder is updated so we</span>
        <span class="c1"># won&#39;t need to do this again.</span>
        <span class="c1"># TODO(stephenfin): Remove once the minimum version of setuptools is</span>
        <span class="c1"># high enough to include https://github.com/pypa/setuptools/pull/1427/</span>
        <span class="k">if</span> <span class="n">needs_reinstall</span><span class="p">:</span>
            <span class="n">egg_info</span><span class="o">.</span><span class="n">setmtime</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">needs_reinstall</span>

    <span class="k">def</span> <span class="nf">install_pkg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_develop</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;just_created&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">action</span><span class="o">.</span><span class="n">setactivity</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="n">pip_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;--exists-action&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_develop</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needs_reinstall</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
                <span class="n">action</span><span class="o">.</span><span class="n">setactivity</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-noop&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="nb">dir</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">action</span><span class="o">.</span><span class="n">setactivity</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-nodeps&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="nb">dir</span><span class="p">)</span>
            <span class="n">pip_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;--no-deps&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">([]</span> <span class="k">if</span> <span class="n">is_develop</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;-U&quot;</span><span class="p">])</span>
        <span class="n">pip_flags</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;-v&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">reporter</span><span class="o">.</span><span class="n">verbosity</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">extras</span><span class="p">:</span>
            <span class="nb">dir</span> <span class="o">+=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">extras</span><span class="p">))</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dir</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_develop</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;-e&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_install</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">extraopts</span><span class="o">=</span><span class="n">pip_flags</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">developpkg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setupdir</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_pkg</span><span class="p">(</span><span class="n">setupdir</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;develop-inst&quot;</span><span class="p">,</span> <span class="n">is_develop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">installpkg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sdistpath</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_pkg</span><span class="p">(</span><span class="n">sdistpath</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;inst&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_installopts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indexserver</span><span class="p">):</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">indexserver</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="n">indexserver</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">pip_pre</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--pre&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">options</span>

    <span class="k">def</span> <span class="nf">run_install_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packages</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">()):</span>
        <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="c1"># expand an install command</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{packages}</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">package</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{opts}</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">opt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">val</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">expand</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">install_command</span><span class="p">))</span>

        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_os_environ</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_pip_os_environ_ok</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

        <span class="n">old_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getwriter</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pcall</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">toxinidir</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
                <span class="n">redirect</span><span class="o">=</span><span class="n">reporter</span><span class="o">.</span><span class="n">verbosity</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">reporter</span><span class="o">.</span><span class="n">Verbosity</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;keyboardinterrupt&quot;</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">old_stdout</span>

    <span class="k">def</span> <span class="nf">ensure_pip_os_environ_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;PIP_RESPECT_VIRTUALENV&quot;</span><span class="p">,</span> <span class="s2">&quot;PIP_REQUIRE_VIRTUALENV&quot;</span><span class="p">,</span> <span class="s2">&quot;__PYVENV_LAUNCHER__&quot;</span><span class="p">):</span>
            <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="s2">&quot;PYTHONPATH&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">passenv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">setenv</span><span class="p">)):</span>
            <span class="c1"># If PYTHONPATH not explicitly asked for, remove it.</span>
            <span class="k">if</span> <span class="s2">&quot;PYTHONPATH&quot;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">]):</span>
                    <span class="c1"># https://docs.python.org/3/whatsnew/3.4.html#changes-in-python-command-behavior</span>
                    <span class="c1"># In a posix shell, setting the PATH environment variable to an empty value is</span>
                    <span class="c1"># equivalent to not setting it at all.</span>
                    <span class="n">reporter</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Discarding $PYTHONPATH from environment, to override &quot;</span>
                        <span class="s2">&quot;specify PYTHONPATH in &#39;passenv&#39; in your configuration.&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">)</span>

        <span class="c1"># installing packages at user level may mean we&#39;re not installing inside the venv</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PIP_USER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>

        <span class="c1"># installing without dependencies may lead to broken packages</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PIP_NO_DEPS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>

    <span class="k">def</span> <span class="nf">_install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">extraopts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deps</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ixservers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">)):</span>
                <span class="n">dep</span> <span class="o">=</span> <span class="n">DepConfig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dep</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">DepConfig</span><span class="p">),</span> <span class="n">dep</span>
            <span class="k">if</span> <span class="n">dep</span><span class="o">.</span><span class="n">indexserver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ixserver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">indexserver</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ixserver</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">indexserver</span>
            <span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ixserver</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ixserver</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ixservers</span><span class="p">:</span>
                <span class="n">ixservers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixserver</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ixserver</span><span class="o">.</span><span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ixserver</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ixserver</span> <span class="ow">in</span> <span class="n">ixservers</span><span class="p">:</span>
            <span class="n">packages</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">ixserver</span><span class="p">]</span>
            <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_installopts</span><span class="p">(</span><span class="n">ixserver</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extraopts</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extraopts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_install_command</span><span class="p">(</span><span class="n">packages</span><span class="o">=</span><span class="n">packages</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_os_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_test_command</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_test_command</span><span class="p">:</span>
            <span class="c1"># for executing tests we construct a clean environment</span>
            <span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">env_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">passenv</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">env_key</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                    <span class="n">env</span><span class="p">[</span><span class="n">env_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">env_key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># for executing non-test commands we use the full</span>
            <span class="c1"># invocation environment</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># in any case we honor per-testenv setenv configuration</span>
        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">setenv</span><span class="o">.</span><span class="n">export</span><span class="p">())</span>

        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;VIRTUAL_ENV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">env</span>

    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">redirect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;run-test&quot;</span><span class="p">,</span>
        <span class="n">commands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_outcome</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">display_hash_seed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">commands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">commands</span>
        <span class="k">if</span> <span class="n">ignore_outcome</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ignore_outcome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">ignore_outcome</span>
        <span class="k">if</span> <span class="n">ignore_errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ignore_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">ignore_errors</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_action</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">action</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">changedir</span>
            <span class="k">if</span> <span class="n">display_hash_seed</span><span class="p">:</span>
                <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_os_environ</span><span class="p">(</span><span class="n">is_test_command</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># Display PYTHONHASHSEED to assist with reproducibility.</span>
                <span class="n">action</span><span class="o">.</span><span class="n">setactivity</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;PYTHONHASHSEED=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYTHONHASHSEED&quot;</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">argv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">commands</span><span class="p">)):</span>
                <span class="c1"># have to make strings as _pcall changes argv[0] to a local()</span>
                <span class="c1"># happens if the same environment is invoked twice</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;commands[</span><span class="si">{}</span><span class="s2">] | </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span>
                    <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pipes</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">argv</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">action</span><span class="o">.</span><span class="n">setactivity</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
                <span class="c1"># check to see if we need to ignore the return code</span>
                <span class="c1"># if so, we need to alter the command line arguments</span>
                <span class="k">if</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                    <span class="n">ignore_ret</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ignore_ret</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pcall</span><span class="p">(</span>
                        <span class="n">argv</span><span class="p">,</span>
                        <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
                        <span class="n">redirect</span><span class="o">=</span><span class="n">redirect</span><span class="p">,</span>
                        <span class="n">ignore_ret</span><span class="o">=</span><span class="n">ignore_ret</span><span class="p">,</span>
                        <span class="n">is_test_command</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">InvocationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ignore_outcome</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;command failed but result from testenv is ignored</span><span class="se">\n</span><span class="s2">cmd:&quot;</span>
                        <span class="n">reporter</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;ignored failed command&quot;</span>
                        <span class="k">continue</span>  <span class="c1"># keep processing commands</span>

                    <span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;commands failed&quot;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                        <span class="k">break</span>  <span class="c1"># Don&#39;t process remaining commands</span>
                <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;keyboardinterrupt&quot;</span>
                    <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_pcall</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">args</span><span class="p">,</span>
        <span class="n">cwd</span><span class="p">,</span>
        <span class="n">venv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">is_test_command</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">redirect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ignore_ret</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">returnout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">capture_err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_os_environ</span><span class="p">(</span><span class="n">is_test_command</span><span class="o">=</span><span class="n">is_test_command</span><span class="p">)</span>

        <span class="c1"># construct environment variables</span>
        <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;VIRTUALENV_PYTHON&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">bin_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envbindir</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">setenv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">bin_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">])</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">verbosity2</span><span class="p">(</span><span class="s2">&quot;setting PATH=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]))</span>

        <span class="c1"># get command</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcommandpath</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">venv</span><span class="p">,</span> <span class="n">cwd</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">InvocationError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_ret</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;command not found but explicitly ignored&quot;</span>
                <span class="n">reporter</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">cmd: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># in case it&#39;s returnout</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s2">&quot;win32&quot;</span> <span class="ow">and</span> <span class="s2">&quot;TOX_LIMITED_SHEBANG&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">prepend_shebang_interpreter</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="n">cwd</span><span class="o">.</span><span class="n">ensure</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ensure the cwd exists</span>
        <span class="k">return</span> <span class="n">action</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">redirect</span><span class="o">=</span><span class="n">redirect</span><span class="p">,</span>
            <span class="n">ignore_ret</span><span class="o">=</span><span class="n">ignore_ret</span><span class="p">,</span>
            <span class="n">returnout</span><span class="o">=</span><span class="n">returnout</span><span class="p">,</span>
            <span class="n">report_fail</span><span class="o">=</span><span class="ow">not</span> <span class="n">is_test_command</span><span class="p">,</span>
            <span class="n">capture_err</span><span class="o">=</span><span class="n">capture_err</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">setupenv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">_missing_subs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;unresolvable substitution(s):</span><span class="se">\n</span><span class="s2">    </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Environment variables are missing or defined recursively.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section_key</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">section_key</span><span class="p">,</span> <span class="n">exc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">_missing_subs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">matching_platform</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;platform mismatch&quot;</span>
            <span class="k">return</span>  <span class="c1"># we simply omit non-matching platforms</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_action</span><span class="p">(</span><span class="s2">&quot;getenv&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envdir</span><span class="p">)</span> <span class="k">as</span> <span class="n">action</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">default_ret_code</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">envlog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_log</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Error creating virtualenv. Note that spaces in paths are &quot;</span>
                    <span class="s2">&quot;not supported by virtualenv. Error details: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">InvocationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">except</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">InterpreterNotFound</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">skip_missing_interpreters</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
                    <span class="n">default_ret_code</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;keyboardinterrupt&quot;</span>
                <span class="k">raise</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">str_status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
                <span class="n">command_log</span> <span class="o">=</span> <span class="n">envlog</span><span class="o">.</span><span class="n">get_commandlog</span><span class="p">(</span><span class="s2">&quot;setup&quot;</span><span class="p">)</span>
                <span class="n">command_log</span><span class="o">.</span><span class="n">add_command</span><span class="p">([</span><span class="s2">&quot;setup virtualenv&quot;</span><span class="p">],</span> <span class="n">str_status</span><span class="p">,</span> <span class="n">default_ret_code</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
                <span class="k">if</span> <span class="n">default_ret_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">reporter</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">str_status</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">str_status</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">command_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcommandpath</span><span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
            <span class="n">envlog</span><span class="o">.</span><span class="n">set_python_info</span><span class="p">(</span><span class="n">command_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">finishvenv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_action</span><span class="p">(</span><span class="s2">&quot;finishvenv&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span></div>


<span class="k">def</span> <span class="nf">getdigest</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="mi">32</span>
    <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">computehash</span><span class="p">(</span><span class="s2">&quot;sha256&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">prepend_shebang_interpreter</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># prepend interpreter directive (if any) to argument list</span>
    <span class="c1">#</span>
    <span class="c1"># When preparing virtual environments in a file container which has large</span>
    <span class="c1"># length, the system might not be able to invoke shebang scripts which</span>
    <span class="c1"># define interpreters beyond system limits (e.g. Linux has a limit of 128;</span>
    <span class="c1"># BINPRM_BUF_SIZE). This method can be used to check if the executable is</span>
    <span class="c1"># a script containing a shebang line. If so, extract the interpreter (and</span>
    <span class="c1"># possible optional argument) and prepend the values to the provided</span>
    <span class="c1"># argument list. tox will only attempt to read an interpreter directive of</span>
    <span class="c1"># a maximum size of 2048 bytes to limit excessive reading and support UNIX</span>
    <span class="c1"># systems which may support a longer interpret length.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;#&quot;</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;!&quot;</span><span class="p">:</span>
                <span class="n">interp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">MAXINTERP</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAXINTERP</span><span class="p">:</span>  <span class="c1"># avoid a truncated interpreter</span>
                    <span class="k">return</span> <span class="n">args</span>
                <span class="n">interp_args</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">interp_args</span> <span class="o">+</span> <span class="n">args</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">args</span>


<span class="n">_SKIP_VENV_CREATION</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_TOX_SKIP_ENV_CREATION_TEST&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>


<span class="nd">@tox</span><span class="o">.</span><span class="n">hookimpl</span>
<span class="k">def</span> <span class="nf">tox_testenv_create</span><span class="p">(</span><span class="n">venv</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="n">config_interpreter</span> <span class="o">=</span> <span class="n">venv</span><span class="o">.</span><span class="n">getsupportedinterpreter</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;virtualenv&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">sitepackages</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--system-site-packages&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">alwayscopy</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--always-copy&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">download</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--no-download&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--download&quot;</span><span class="p">)</span>
    <span class="c1"># add interpreter explicitly, to prevent using default (virtualenv.ini)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--python&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">config_interpreter</span><span class="p">)])</span>

    <span class="n">cleanup_for_venv</span><span class="p">(</span><span class="n">venv</span><span class="p">)</span>

    <span class="n">base_path</span> <span class="o">=</span> <span class="n">venv</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirpath</span><span class="p">()</span>
    <span class="n">base_path</span><span class="o">.</span><span class="n">ensure</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">venv</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_SKIP_VENV_CREATION</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">venv</span><span class="o">.</span><span class="n">_pcall</span><span class="p">(</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">venv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="n">base_path</span><span class="p">,</span>
                <span class="n">redirect</span><span class="o">=</span><span class="n">reporter</span><span class="o">.</span><span class="n">verbosity</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">reporter</span><span class="o">.</span><span class="n">Verbosity</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">venv</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;keyboardinterrupt&quot;</span>
            <span class="k">raise</span>
    <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Return non-None to indicate plugin has completed</span>


<span class="k">def</span> <span class="nf">cleanup_for_venv</span><span class="p">(</span><span class="n">venv</span><span class="p">):</span>
    <span class="n">within_parallel</span> <span class="o">=</span> <span class="n">PARALLEL_ENV_VAR_KEY_PRIVATE</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
    <span class="c1"># if the directory exists and it doesn&#39;t look like a virtualenv, produce</span>
    <span class="c1"># an error</span>
    <span class="k">if</span> <span class="n">venv</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">dir_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">venv</span><span class="o">.</span><span class="n">path</span><span class="p">)))</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;.lock&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">}</span>
        <span class="n">dir_items</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dir_items</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.tox-&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p</span> <span class="o">==</span> <span class="s2">&quot;.tox-config1&quot;</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dir_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="c1"># doesn&#39;t exist =&gt; OK</span>
        <span class="ow">not</span> <span class="n">venv</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="c1"># does exist, but it&#39;s empty =&gt; OK</span>
        <span class="ow">or</span> <span class="ow">not</span> <span class="n">dir_items</span>
        <span class="c1"># tox has marked this as an environment it has created in the past</span>
        <span class="ow">or</span> <span class="s2">&quot;.tox-config1&quot;</span> <span class="ow">in</span> <span class="n">dir_items</span>
        <span class="c1"># it exists and we&#39;re on windows with Lib and Scripts =&gt; OK</span>
        <span class="ow">or</span> <span class="p">(</span><span class="n">INFO</span><span class="o">.</span><span class="n">IS_WIN</span> <span class="ow">and</span> <span class="n">dir_items</span> <span class="o">&gt;</span> <span class="p">{</span><span class="s2">&quot;Scripts&quot;</span><span class="p">,</span> <span class="s2">&quot;Lib&quot;</span><span class="p">})</span>
        <span class="c1"># non-windows, with lib and bin =&gt; OK</span>
        <span class="ow">or</span> <span class="n">dir_items</span> <span class="o">&gt;</span> <span class="p">{</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">}</span>
        <span class="c1"># pypy has a different lib folder =&gt; OK</span>
        <span class="ow">or</span> <span class="n">dir_items</span> <span class="o">&gt;</span> <span class="p">{</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;lib_pypy&quot;</span><span class="p">}</span>
    <span class="p">):</span>
        <span class="n">venv</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;cowardly refusing to delete `envdir` (it does not look like a virtualenv): &quot;</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">venv</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">within_parallel</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">venv</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1"># do not delete the log folder as that&#39;s used by parent</span>
            <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">venv</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                    <span class="n">content</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rec</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ensure_empty_dir</span><span class="p">(</span><span class="n">venv</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>


<span class="nd">@tox</span><span class="o">.</span><span class="n">hookimpl</span>
<span class="k">def</span> <span class="nf">tox_testenv_install_deps</span><span class="p">(</span><span class="n">venv</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="n">venv</span><span class="o">.</span><span class="n">get_resolved_dependencies</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">deps</span><span class="p">:</span>
        <span class="n">depinfo</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">deps</span><span class="p">))</span>
        <span class="n">action</span><span class="o">.</span><span class="n">setactivity</span><span class="p">(</span><span class="s2">&quot;installdeps&quot;</span><span class="p">,</span> <span class="n">depinfo</span><span class="p">)</span>
        <span class="n">venv</span><span class="o">.</span><span class="n">_install</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Return non-None to indicate plugin has completed</span>


<span class="nd">@tox</span><span class="o">.</span><span class="n">hookimpl</span>
<span class="k">def</span> <span class="nf">tox_runtest</span><span class="p">(</span><span class="n">venv</span><span class="p">,</span> <span class="n">redirect</span><span class="p">):</span>
    <span class="n">venv</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">redirect</span><span class="o">=</span><span class="n">redirect</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Return non-None to indicate plugin has completed</span>


<span class="nd">@tox</span><span class="o">.</span><span class="n">hookimpl</span>
<span class="k">def</span> <span class="nf">tox_runtest_pre</span><span class="p">(</span><span class="n">venv</span><span class="p">):</span>
    <span class="n">venv</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ensure_empty_dir</span><span class="p">(</span><span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envtmpdir</span><span class="p">)</span>
    <span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envtmpdir</span><span class="o">.</span><span class="n">ensure</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">venv</span><span class="o">.</span><span class="n">test</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;run-test-pre&quot;</span><span class="p">,</span>
        <span class="n">commands</span><span class="o">=</span><span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">commands_pre</span><span class="p">,</span>
        <span class="n">redirect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_outcome</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">display_hash_seed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@tox</span><span class="o">.</span><span class="n">hookimpl</span>
<span class="k">def</span> <span class="nf">tox_runtest_post</span><span class="p">(</span><span class="n">venv</span><span class="p">):</span>
    <span class="n">venv</span><span class="o">.</span><span class="n">test</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;run-test-post&quot;</span><span class="p">,</span>
        <span class="n">commands</span><span class="o">=</span><span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">commands_post</span><span class="p">,</span>
        <span class="n">redirect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_outcome</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@tox</span><span class="o">.</span><span class="n">hookimpl</span>
<span class="k">def</span> <span class="nf">tox_runenvreport</span><span class="p">(</span><span class="n">venv</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="c1"># write out version dependency information</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">list_dependencies_command</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">venv</span><span class="o">.</span><span class="n">_pcall</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">toxinidir</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">returnout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># the output contains a mime-header, skip it</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">packages</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">packages</span>  <span class="c1"># Return non-None to indicate plugin has completed</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/img/tox.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">standardise testing in Python</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=tox-dev&repo=tox&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<div id="searchbox" style="display: none">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="搜索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>

<h3>quicklinks</h3>
<div style="text-align: left; font-size: 100%; vertical-align: middle;">
<table>
<tr>
<td>
        <a href="../../index.html">home</a>
</td><td>
        <a href="../../examples.html">examples</a>
</td></tr><tr><td>
        <a href="../../install.html">install</a>
</td><td>
        <a href="../../changelog.html">changelog</a>
</td></tr><tr><td>
        <a href="../../config.html">config</a>
</td><td>
        <a href="https://github.com/tox-dev/tox/issues">issues[gh]</a>
</td></tr><tr><td>
        <a href="../../support.html">support</a>
</td><td>
        <a href="../../plugins.html">plugins/hooks</a>
</td>
</tr></table>
</div>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">模块代码</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2010-2022, holger krekel and others.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/tox-dev/tox" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>