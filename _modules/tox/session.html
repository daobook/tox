
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tox.session &#8212; tox 0.1.dev1 文档</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/translations.js"></script>
    <link rel="shortcut icon" href="../../_static/toxfavi.ico"/>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>tox.session 源代码</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Automatically package and test a Python project against configurable</span>
<span class="sd">Python2 and Python3 based virtual environments. Environments are</span>
<span class="sd">setup by using virtualenv. Configuration is generally done through an</span>
<span class="sd">INI-style &quot;tox.ini&quot; file.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="kn">import</span> <span class="nn">py</span>

<span class="kn">import</span> <span class="nn">tox</span>
<span class="kn">from</span> <span class="nn">tox</span> <span class="kn">import</span> <span class="n">reporter</span>
<span class="kn">from</span> <span class="nn">tox.action</span> <span class="kn">import</span> <span class="n">Action</span>
<span class="kn">from</span> <span class="nn">tox.config</span> <span class="kn">import</span> <span class="n">INTERRUPT_TIMEOUT</span><span class="p">,</span> <span class="n">SUICIDE_TIMEOUT</span><span class="p">,</span> <span class="n">TERMINATE_TIMEOUT</span><span class="p">,</span> <span class="n">parseconfig</span>
<span class="kn">from</span> <span class="nn">tox.config.parallel</span> <span class="kn">import</span> <span class="n">ENV_VAR_KEY_PRIVATE</span> <span class="k">as</span> <span class="n">PARALLEL_ENV_VAR_KEY_PRIVATE</span>
<span class="kn">from</span> <span class="nn">tox.config.parallel</span> <span class="kn">import</span> <span class="n">OFF_VALUE</span> <span class="k">as</span> <span class="n">PARALLEL_OFF</span>
<span class="kn">from</span> <span class="nn">tox.logs.result</span> <span class="kn">import</span> <span class="n">ResultLog</span>
<span class="kn">from</span> <span class="nn">tox.reporter</span> <span class="kn">import</span> <span class="n">update_default_reporter</span>
<span class="kn">from</span> <span class="nn">tox.util</span> <span class="kn">import</span> <span class="n">set_os_env_var</span>
<span class="kn">from</span> <span class="nn">tox.util.graph</span> <span class="kn">import</span> <span class="n">stable_topological_sort</span>
<span class="kn">from</span> <span class="nn">tox.util.stdlib</span> <span class="kn">import</span> <span class="n">suppress_output</span>
<span class="kn">from</span> <span class="nn">tox.venv</span> <span class="kn">import</span> <span class="n">VirtualEnv</span>

<span class="kn">from</span> <span class="nn">.commands.help</span> <span class="kn">import</span> <span class="n">show_help</span>
<span class="kn">from</span> <span class="nn">.commands.help_ini</span> <span class="kn">import</span> <span class="n">show_help_ini</span>
<span class="kn">from</span> <span class="nn">.commands.provision</span> <span class="kn">import</span> <span class="n">provision_tox</span>
<span class="kn">from</span> <span class="nn">.commands.run.parallel</span> <span class="kn">import</span> <span class="n">run_parallel</span>
<span class="kn">from</span> <span class="nn">.commands.run.sequential</span> <span class="kn">import</span> <span class="n">run_sequential</span>
<span class="kn">from</span> <span class="nn">.commands.show_config</span> <span class="kn">import</span> <span class="n">show_config</span>
<span class="kn">from</span> <span class="nn">.commands.show_env</span> <span class="kn">import</span> <span class="n">show_envs</span>


<span class="k">def</span> <span class="nf">cmdline</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">setup_reporter</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>

    <span class="kn">from</span> <span class="nn">tox.config.reporter</span> <span class="kn">import</span> <span class="n">add_verbosity_commands</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">add_verbosity_commands</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">suppress_output</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">options</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">update_default_reporter</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">quiet_level</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose_level</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
            <span class="k">pass</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">setup_reporter</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">logdir</span><span class="o">.</span><span class="n">ensure</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">set_os_env_var</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;TOX_WORK_DIR&quot;</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">toxworkdir</span><span class="p">):</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">build_session</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="n">exit_code</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">runcommand</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exit_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">exit_code</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">BadRequirement</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">parseconfig</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
            <span class="n">show_help</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">helpini</span><span class="p">:</span>
            <span class="n">show_help_ini</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">MissingRequirement</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">config</span>
    <span class="k">return</span> <span class="n">config</span>


<span class="k">def</span> <span class="nf">build_session</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Session</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>


<div class="viewcode-block" id="Session"><a class="viewcode-back" href="../../plugins.html#tox.session.Session">[文档]</a><span class="k">class</span> <span class="nc">Session</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The session object that ties together configuration, reporting, venv creation, testing.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">popen</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">popen</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">popen</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popen</span> <span class="o">=</span> <span class="n">popen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resultlog</span> <span class="o">=</span> <span class="n">ResultLog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">existing_venvs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">venv_dict</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run_provision</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_venvs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_build_venvs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">need_to_run</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getvenv</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated_env_list</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">venv_order</span> <span class="o">=</span> <span class="n">stable_topological_sort</span><span class="p">(</span>
                    <span class="n">OrderedDict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">depends</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">need_to_run</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                <span class="p">)</span>

                <span class="n">venvs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">need_to_run</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">venv_order</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">venvs</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                <span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;circular dependency detected: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">ConfigError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getvenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">existing_venvs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">existing_venvs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">env_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">envconfigs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown environment </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">env_config</span><span class="o">.</span><span class="n">envdir</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">toxinidir</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;venv </span><span class="si">{!r}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2"> would delete project&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">env_config</span><span class="o">.</span><span class="n">envdir</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">(</span><span class="s2">&quot;envdir must not equal toxinidir&quot;</span><span class="p">)</span>
        <span class="n">env_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resultlog</span><span class="o">.</span><span class="n">get_envlog</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">venv</span> <span class="o">=</span> <span class="n">VirtualEnv</span><span class="p">(</span><span class="n">envconfig</span><span class="o">=</span><span class="n">env_config</span><span class="p">,</span> <span class="n">popen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">popen</span><span class="p">,</span> <span class="n">env_log</span><span class="o">=</span><span class="n">env_log</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">existing_venvs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">venv</span>
        <span class="k">return</span> <span class="n">venv</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_evaluated_env_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tox_env_filter</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TOX_SKIP_ENV&quot;</span><span class="p">)</span>
        <span class="n">tox_env_filter_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">tox_env_filter</span><span class="p">)</span> <span class="k">if</span> <span class="n">tox_env_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">envlist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tox_env_filter_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tox_env_filter_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;skip environment </span><span class="si">{}</span><span class="s2">, matches filter </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">tox_env_filter_re</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">reporter</span><span class="o">.</span><span class="n">verbosity1</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">hook</span>

    <span class="k">def</span> <span class="nf">newaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Action</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">msg</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logdir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">resultjson</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resultlog</span><span class="o">.</span><span class="n">command_log</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">popen</span><span class="p">,</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
            <span class="n">SUICIDE_TIMEOUT</span><span class="p">,</span>
            <span class="n">INTERRUPT_TIMEOUT</span><span class="p">,</span>
            <span class="n">TERMINATE_TIMEOUT</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">runcommand</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">using</span><span class="p">(</span>
            <span class="s2">&quot;tox-</span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2"> (pid </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tox</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="n">tox</span><span class="o">.</span><span class="vm">__file__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="n">show_description</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">has_level</span><span class="p">(</span><span class="n">reporter</span><span class="o">.</span><span class="n">Verbosity</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run_provision</span><span class="p">:</span>
            <span class="n">provision_tox_venv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getvenv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">provision_tox_env</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">provision_tox</span><span class="p">(</span><span class="n">provision_tox_venv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">showconfig</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showconfig</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">listenvs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showenvs</span><span class="p">(</span><span class="n">all_envs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">show_description</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">listenvs_all</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showenvs</span><span class="p">(</span><span class="n">all_envs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">show_description</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">():</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcommand_test</span><span class="p">()</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">ensure</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">tox_cleanup</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">subcommand_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">skipsdist</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;skipping sdist step&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">venv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">venv_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">skip_install</span><span class="p">:</span>
                    <span class="n">venv</span><span class="o">.</span><span class="n">package</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">tox_package</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">venv</span><span class="o">=</span><span class="n">venv</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">venv</span><span class="o">.</span><span class="n">package</span><span class="p">:</span>
                        <span class="k">return</span> <span class="mi">2</span>
                    <span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">setenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;TOX_PACKAGE&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">venv</span><span class="o">.</span><span class="n">package</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">sdistonly</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">within_parallel</span> <span class="o">=</span> <span class="n">PARALLEL_ENV_VAR_KEY_PRIVATE</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">within_parallel</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">parallel</span> <span class="o">!=</span> <span class="n">PARALLEL_OFF</span><span class="p">:</span>
                <span class="n">run_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">venv_dict</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run_sequential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">venv_dict</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">retcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">retcode</span>

    <span class="k">def</span> <span class="nf">_add_parallel_summaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">parallel</span> <span class="o">!=</span> <span class="n">PARALLEL_OFF</span> <span class="ow">and</span> <span class="s2">&quot;testenvs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resultlog</span><span class="o">.</span><span class="n">dict</span><span class="p">:</span>
            <span class="n">result_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resultlog</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s2">&quot;testenvs&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tox_env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">venv_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_parallel_env_report</span><span class="p">(</span><span class="n">tox_env</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">and</span> <span class="s2">&quot;testenvs&quot;</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">tox_env</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;testenvs&quot;</span><span class="p">]:</span>
                    <span class="n">result_log</span><span class="p">[</span><span class="n">tox_env</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;testenvs&quot;</span><span class="p">][</span><span class="n">tox_env</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_load_parallel_env_report</span><span class="p">(</span><span class="n">tox_env</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load report data into memory, remove disk file&quot;&quot;&quot;</span>
        <span class="n">result_json_path</span> <span class="o">=</span> <span class="n">tox_env</span><span class="o">.</span><span class="n">get_result_json_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result_json_path</span> <span class="ow">and</span> <span class="n">result_json_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">result_json_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_handler</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
            <span class="n">result_json_path</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">is_parallel_child</span> <span class="o">=</span> <span class="n">PARALLEL_ENV_VAR_KEY_PRIVATE</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_parallel_child</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">separator</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="n">reporter</span><span class="o">.</span><span class="n">Verbosity</span><span class="o">.</span><span class="n">QUIET</span><span class="p">)</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">venv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">venv_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">good</span>
            <span class="n">status</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">venv</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">tox</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">InterpreterNotFound</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">skip_missing_interpreters</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
                    <span class="n">report</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">skip</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">report</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">error</span>
            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;platform mismatch&quot;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{!r}</span><span class="s2"> does not match </span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envname</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span>
                    <span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">report</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">skip</span>
            <span class="k">elif</span> <span class="n">status</span> <span class="ow">and</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ignored failed command&quot;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">status</span> <span class="ow">and</span> <span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;skipped tests&quot;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
                <span class="n">report</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">error</span>
                <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;commands succeeded&quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">venv</span><span class="o">.</span><span class="n">envconfig</span><span class="o">.</span><span class="n">envname</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_parallel_child</span><span class="p">:</span>
                <span class="n">report</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exit_code</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_parallel_child</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">good</span><span class="p">(</span><span class="s2">&quot;  congratulations :)&quot;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">resultjson</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_parallel_child</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_parallel_summaries</span><span class="p">()</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resultlog</span><span class="o">.</span><span class="n">dumps_json</span><span class="p">()</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;write json report at: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">path</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exit_code</span>

    <span class="k">def</span> <span class="nf">showconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">show_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">showenvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_envs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">show_envs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">all_envs</span><span class="o">=</span><span class="n">all_envs</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/img/tox.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">standardise testing in Python</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=tox-dev&repo=tox&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<div id="searchbox" style="display: none">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="搜索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>

<h3>quicklinks</h3>
<div style="text-align: left; font-size: 100%; vertical-align: middle;">
<table>
<tr>
<td>
        <a href="../../index.html">home</a>
</td><td>
        <a href="../../examples.html">examples</a>
</td></tr><tr><td>
        <a href="../../install.html">install</a>
</td><td>
        <a href="../../changelog.html">changelog</a>
</td></tr><tr><td>
        <a href="../../config.html">config</a>
</td><td>
        <a href="https://github.com/tox-dev/tox/issues">issues[gh]</a>
</td></tr><tr><td>
        <a href="../../support.html">support</a>
</td><td>
        <a href="../../plugins.html">plugins/hooks</a>
</td>
</tr></table>
</div>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">模块代码</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2010-2022, holger krekel and others.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/tox-dev/tox" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>