
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Using tox with the Jenkins Integration Server &#8212; tox 0.1.dev1 文档</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/translations.js"></script>
    <link rel="shortcut icon" href="../_static/toxfavi.ico"/>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Development environment" href="devenv.html" />
    <link rel="prev" title="General tips and tricks" href="general.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="using-tox-with-the-jenkins-integration-server">
<h1>Using tox with the Jenkins Integration Server<a class="headerlink" href="#using-tox-with-the-jenkins-integration-server" title="永久链接至标题">¶</a></h1>
<section id="using-jenkins-multi-configuration-jobs">
<h2>Using Jenkins multi-configuration jobs<a class="headerlink" href="#using-jenkins-multi-configuration-jobs" title="永久链接至标题">¶</a></h2>
<p>The <a class="reference external" href="https://jenkins.io/index.html">Jenkins</a> continuous integration server allows you to define “jobs” with
“build steps” which can be test invocations.  If you <a class="reference internal" href="../install.html"><span class="doc">install</span></a> <code class="docutils literal notranslate"><span class="pre">tox</span></code> on your
default Python installation on each Jenkins agent, you can easily create
a Jenkins multi-configuration job that will drive your tox runs from the CI-server side,
using these steps:</p>
<ul>
<li><p>install the Python plugin for Jenkins under “manage jenkins”</p></li>
<li><p>create a “multi-configuration” job, give it a name of your choice</p></li>
<li><p>configure your repository so that Jenkins can pull it</p></li>
<li><p>(optional) configure multiple nodes so that tox-runs are performed
on multiple hosts</p></li>
<li><p>configure <code class="docutils literal notranslate"><span class="pre">axes</span></code> by using <a class="reference internal" href="general.html#toxenv"><span class="std std-ref">TOXENV</span></a> as an axis
name and as values provide space-separated test environment names
you want Jenkins/tox to execute.</p></li>
<li><p>add a <strong>Python-build step</strong> with this content (see also next example):</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tox</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;WORKSPACE&quot;</span><span class="p">))</span>
<span class="n">tox</span><span class="o">.</span><span class="n">cmdline</span><span class="p">()</span>  <span class="c1"># environment is selected by ``TOXENV`` env variable</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>check <code class="docutils literal notranslate"><span class="pre">Publish</span> <span class="pre">JUnit</span> <span class="pre">test</span> <span class="pre">result</span> <span class="pre">report</span></code> and enter
<code class="docutils literal notranslate"><span class="pre">**/junit-*.xml</span></code> as the pattern so that Jenkins collects
test results in the JUnit XML format.</p></li>
</ul>
<p>The last point requires that your test command creates JunitXML files,
for example with <code class="docutils literal notranslate"><span class="pre">pytest</span></code> it is done like this:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[testenv]</span><span class="w"></span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pytest --junitxml=junit-{envname}.xml</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="zero-installation-for-agents">
<h2><strong>zero-installation</strong> for agents<a class="headerlink" href="#zero-installation-for-agents" title="永久链接至标题">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>This feature is broken currently because “toxbootstrap.py”
has been removed.  Please file an issue if you’d like to
see it back.</p>
</div>
<p>If you manage many Jenkins agents and want to use the latest officially
released tox (or latest development version) and want to skip manually
installing <code class="docutils literal notranslate"><span class="pre">tox</span></code> then substitute the above <strong>Python build step</strong> code
with this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span><span class="o">,</span> <span class="nn">os</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://bitbucket.org/hpk42/tox/raw/default/toxbootstrap.py&quot;</span>
<span class="c1"># os.environ[&#39;USETOXDEV&#39;]=&quot;1&quot;  # use tox dev version</span>
<span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="vm">__file__</span><span class="o">=</span><span class="s2">&quot;toxbootstrap.py&quot;</span><span class="p">)</span>
<span class="n">exec</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="ow">in</span> <span class="n">d</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;cmdline&quot;</span><span class="p">]([</span><span class="s2">&quot;--recreate&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>The downloaded <code class="docutils literal notranslate"><span class="pre">toxbootstrap.py</span></code> file downloads all necessary files to
install <code class="docutils literal notranslate"><span class="pre">tox</span></code> in a virtual sub environment.  Notes:</p>
<ul class="simple">
<li><p>uncomment the line containing <code class="docutils literal notranslate"><span class="pre">USETOXDEV</span></code> to use the latest
development-release version of tox instead of the
latest released version.</p></li>
<li><p>adapt the options in the last line as needed (the example code
will cause tox to reinstall all virtual environments all the time
which is often what one wants in CI server contexts)</p></li>
</ul>
</section>
<section id="integrating-sphinx-documentation-checks-in-a-jenkins-job">
<h2>Integrating “sphinx” documentation checks in a Jenkins job<a class="headerlink" href="#integrating-sphinx-documentation-checks-in-a-jenkins-job" title="永久链接至标题">¶</a></h2>
<p>If you are using a multi-configuration Jenkins job which collects
JUnit Test results you will run into problems using the previous
method of running the sphinx-build command because it will not
generate JUnit results.  To accommodate this issue one solution
is to have <code class="docutils literal notranslate"><span class="pre">pytest</span></code> wrap the sphinx-checks and create a
JUnit result file which wraps the result of calling sphinx-build.
Here is an example:</p>
<ol class="arabic simple">
<li><p>create a <code class="docutils literal notranslate"><span class="pre">docs</span></code> environment in your <code class="docutils literal notranslate"><span class="pre">tox.ini</span></code> file like this:</p></li>
</ol>
<blockquote>
<div><div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[testenv:docs]</span><span class="w"></span>
<span class="na">basepython</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">python</span><span class="w"></span>
<span class="c1"># change to ``doc`` dir if that is where your sphinx-docs live</span><span class="w"></span>
<span class="na">changedir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">doc</span><span class="w"></span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">sphinx</span><span class="w"></span>
<span class="w">       </span><span class="na">pytest</span><span class="w"></span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pytest --tb=line -v --junitxml=junit-{envname}.xml check_sphinx.py</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>create a <code class="docutils literal notranslate"><span class="pre">doc/check_sphinx.py</span></code> file like this:</p></li>
</ol>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">subprocess</span>


<span class="k">def</span> <span class="nf">test_linkcheck</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
    <span class="n">doctrees</span> <span class="o">=</span> <span class="n">tmpdir</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;doctrees&quot;</span><span class="p">)</span>
    <span class="n">htmldir</span> <span class="o">=</span> <span class="n">tmpdir</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;sphinx-build&quot;</span><span class="p">,</span> <span class="s2">&quot;-W&quot;</span><span class="p">,</span> <span class="s2">&quot;-blinkcheck&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">doctrees</span><span class="p">),</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">htmldir</span><span class="p">)]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_build_docs</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
    <span class="n">doctrees</span> <span class="o">=</span> <span class="n">tmpdir</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;doctrees&quot;</span><span class="p">)</span>
    <span class="n">htmldir</span> <span class="o">=</span> <span class="n">tmpdir</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;sphinx-build&quot;</span><span class="p">,</span> <span class="s2">&quot;-W&quot;</span><span class="p">,</span> <span class="s2">&quot;-bhtml&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">doctrees</span><span class="p">),</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">htmldir</span><span class="p">)]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>run <code class="docutils literal notranslate"><span class="pre">tox</span> <span class="pre">-e</span> <span class="pre">docs</span></code> and then you may integrate this environment
along with your other environments into Jenkins.</p></li>
</ol>
<p>Note that <code class="docutils literal notranslate"><span class="pre">pytest</span></code> is only installed into the docs environment
and does not need to be in use or installed with any other environment.</p>
</section>
<section id="access-package-artifacts-between-jenkins-jobs">
<span id="jenkins-artifact-example"></span><h2>Access package artifacts between Jenkins jobs<a class="headerlink" href="#access-package-artifacts-between-jenkins-jobs" title="永久链接至标题">¶</a></h2>
<p>In an extension to <a class="reference internal" href="general.html#artifacts"><span class="std std-ref">Access package artifacts between multiple tox-runs</span></a> you can also configure Jenkins jobs to
access each others artifacts.  <code class="docutils literal notranslate"><span class="pre">tox</span></code> uses the <code class="docutils literal notranslate"><span class="pre">distshare</span></code> directory
to access artifacts and in a Jenkins context (detected via existence
of the environment variable <code class="docutils literal notranslate"><span class="pre">HUDSON_URL</span></code>); it defaults to
to <code class="docutils literal notranslate"><span class="pre">{toxworkdir}/distshare</span></code>.</p>
<p>This means that each workspace will have its own <code class="docutils literal notranslate"><span class="pre">distshare</span></code>
directory and we need to configure Jenkins to perform artifact copying.
The recommend way to do this is to install the <a class="reference external" href="https://wiki.jenkins.io/display/JENKINS/Copy+Artifact+Plugin">Jenkins Copy Artifact plugin</a>
and for each job which “receives” artifacts you add a <strong>Copy artifacts from another project</strong> build step
using roughly this configuration:</p>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Project-name: name of the other <span class="o">(</span>tox-managed<span class="o">)</span> job you want the artifact from
Artifacts to copy: .tox/dist/*.zip   <span class="c1"># where tox jobs create artifacts</span>
Target directory: .tox/distshare     <span class="c1"># where we want it to appear for us</span>
Flatten Directories: CHECK           <span class="c1"># create no subdir-structure</span>
</pre></div>
</div>
</div></blockquote>
<p>You also need to configure the “other” job to archive artifacts; This
is done by checking <code class="docutils literal notranslate"><span class="pre">Archive</span> <span class="pre">the</span> <span class="pre">artifacts</span></code> and entering:</p>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Files to archive: .tox/dist/*.zip
</pre></div>
</div>
</div></blockquote>
<p>So our “other” job will create an sdist-package artifact and
the “copy-artifacts” plugin will copy it to our <code class="docutils literal notranslate"><span class="pre">distshare</span></code> area.
Now everything proceeds as <a class="reference internal" href="general.html#artifacts"><span class="std std-ref">Access package artifacts between multiple tox-runs</span></a> shows it.</p>
<p>So if you are using defaults you can re-use and debug exactly the
same <code class="docutils literal notranslate"><span class="pre">tox.ini</span></code> file and make use of automatic sharing of
your artifacts between runs or Jenkins jobs.</p>
</section>
<section id="avoiding-the-path-too-long-error-with-long-shebang-lines">
<h2>Avoiding the “path too long” error with long shebang lines<a class="headerlink" href="#avoiding-the-path-too-long-error-with-long-shebang-lines" title="永久链接至标题">¶</a></h2>
<p>When using <code class="docutils literal notranslate"><span class="pre">tox</span></code> on a Jenkins instance, there may be a scenario where <code class="docutils literal notranslate"><span class="pre">tox</span></code>
can not invoke <code class="docutils literal notranslate"><span class="pre">pip</span></code> because the shebang (Unix) line is too long. Some systems
only support a limited amount of characters for an interpreter directive (e.x.
Linux as a limit of 128). There are two methods to workaround this issue:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Invoke <code class="docutils literal notranslate"><span class="pre">tox</span></code> with the <code class="docutils literal notranslate"><span class="pre">--workdir</span></code> option which tells <code class="docutils literal notranslate"><span class="pre">tox</span></code> to use a
specific directory for its virtual environments. Using a unique and short
path can prevent this issue.</p></li>
<li><p>Use the environment variable <code class="docutils literal notranslate"><span class="pre">TOX_LIMITED_SHEBANG</span></code> to deal with
environments with interpreter directive limitations (consult
<a class="reference internal" href="../config.html#long-interpreter-directives"><span class="std std-ref">Handle interpreter directives with long lengths</span></a> for more information).</p></li>
</ol>
</div></blockquote>
</section>
<section id="running-tox-environments-in-parallel">
<h2>Running tox environments in parallel<a class="headerlink" href="#running-tox-environments-in-parallel" title="永久链接至标题">¶</a></h2>
<p>Jenkins has parallel stages allowing you to run commands in parallel, however tox package
building it is not parallel safe. Use the <code class="docutils literal notranslate"><span class="pre">--parallel--safe-build</span></code> flag to enable parallel safe
builds (this will generate unique folder names for <code class="docutils literal notranslate"><span class="pre">distdir</span></code>, <code class="docutils literal notranslate"><span class="pre">distshare</span></code> and <code class="docutils literal notranslate"><span class="pre">log</span></code>.
Here’s a generic stage definition demonstrating how to use this inside Jenkins:</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;run tox envs&#39;</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">steps</span> <span class="o">{</span>
    <span class="n">script</span> <span class="o">{</span>
      <span class="kt">def</span> <span class="n">envs</span> <span class="o">=</span> <span class="n">sh</span><span class="o">(</span><span class="nl">returnStdout:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">script:</span> <span class="s2">&quot;tox -l&quot;</span><span class="o">).</span><span class="na">trim</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s1">&#39;\n&#39;</span><span class="o">)</span>
      <span class="kt">def</span> <span class="n">cmds</span> <span class="o">=</span> <span class="n">envs</span><span class="o">.</span><span class="na">collectEntries</span><span class="o">({</span> <span class="n">tox_env</span> <span class="o">-&gt;</span>
        <span class="o">[</span><span class="n">tox_env</span><span class="o">,</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">&quot;tox --parallel--safe-build -vve $tox_env&quot;</span>
        <span class="o">}]</span>
      <span class="o">})</span>
      <span class="n">parallel</span><span class="o">(</span><span class="n">cmds</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/img/tox.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">standardise testing in Python</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=tox-dev&repo=tox&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<div id="searchbox" style="display: none">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="搜索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>

<h3>quicklinks</h3>
<div style="text-align: left; font-size: 100%; vertical-align: middle;">
<table>
<tr>
<td>
        <a href="../index.html">home</a>
</td><td>
        <a href="../examples.html">examples</a>
</td></tr><tr><td>
        <a href="../install.html">install</a>
</td><td>
        <a href="../changelog.html">changelog</a>
</td></tr><tr><td>
        <a href="../config.html">config</a>
</td><td>
        <a href="https://github.com/tox-dev/tox/issues">issues[gh]</a>
</td></tr><tr><td>
        <a href="../support.html">support</a>
</td><td>
        <a href="../plugins.html">plugins/hooks</a>
</td>
</tr></table>
</div>

  <div>
    <h3><a href="../index.html">目录</a></h3>
    <ul>
<li><a class="reference internal" href="#">Using tox with the Jenkins Integration Server</a><ul>
<li><a class="reference internal" href="#using-jenkins-multi-configuration-jobs">Using Jenkins multi-configuration jobs</a></li>
<li><a class="reference internal" href="#zero-installation-for-agents"><strong>zero-installation</strong> for agents</a></li>
<li><a class="reference internal" href="#integrating-sphinx-documentation-checks-in-a-jenkins-job">Integrating “sphinx” documentation checks in a Jenkins job</a></li>
<li><a class="reference internal" href="#access-package-artifacts-between-jenkins-jobs">Access package artifacts between Jenkins jobs</a></li>
<li><a class="reference internal" href="#avoiding-the-path-too-long-error-with-long-shebang-lines">Avoiding the “path too long” error with long shebang lines</a></li>
<li><a class="reference internal" href="#running-tox-environments-in-parallel">Running tox environments in parallel</a></li>
</ul>
</li>
</ul>

  </div><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../examples.html">tox configuration and usage examples</a><ul>
      <li>Previous: <a href="general.html" title="上一章">General tips and tricks</a></li>
      <li>Next: <a href="devenv.html" title="下一章">Development environment</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2010-2022, holger krekel and others.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/tox-dev/tox" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>